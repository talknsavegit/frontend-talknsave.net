jQuery(document).ready(function(a){"use strict";function b(){a("#filterDate1").datepicker();var b=a("#filterDate1").datepicker("getDate");ia=b.getTime()/1e3+parseInt(hkbAnalyticsChart.beginDateOffset)}function c(){a("#filterDate2").datepicker();var b=a("#filterDate2").datepicker("getDate");ja=b.getTime()/1e3+parseInt(hkbAnalyticsChart.endDateOffset)}function d(){a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"updateusermetadates",action:"hkba_dynamic_stats",nonce:R(".hkb-analyticsdate"),begin:ia,end:ja,period:ka},success:function(a){}})}function e(){var b=a("#js-hkba-chart-kbviews")[0];b.width=b.width,a("#js-hkba-chart-kbviews-info").empty(),a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"kboverviewmonthly",action:"hkba_dynamic_stats",nonce:R("#js-hkba-chart-kbviews"),begin:ia,end:ja},beforeSend:function(a){da("#js-hkba-dash-views-panel")},success:function(b){if(va={labels:b.labels,datasets:[{label:b.searchesLabel,fillColor:"rgba(74, 136, 218,0.2)",strokeColor:"rgba(74, 136, 218,1.0)",pointColor:"rgba(74, 136, 218,1.0)",pointStrokeColor:"rgba(74, 136, 218,1.0)",pointHighlightFill:"rgba(52, 73, 94,1.0)",pointHighlightStroke:"rgba(52, 73, 94,1.0)",data:b.searches},{label:b.transfersLabel,fillColor:"rgba(232, 85, 62,0.2)",strokeColor:"rgba(232, 85, 62,1.0)",pointColor:"rgba(232, 85, 62,1.0)",pointStrokeColor:"(232, 85, 62,1.0)",pointHighlightFill:"rgba(52, 73, 94,1.0)",pointHighlightStroke:"rgba(52, 73, 94,1.0)",data:b.transfers}]},0!=b.searches.length){var c=a("#js-hkba-chart-kbviews"),d=c.get(0).getContext("2d");d.canvas.originalwidth=d.canvas.width,d.canvas.originalheight=d.canvas.height;try{na.destroy()}catch(a){}d.canvas.width=500,d.canvas.height=500,na=new Chart(d).Line(va,{responsive:!0,maintainAspectRatio:!1,legendTemplate:'<ul class="hkb-chart-legend"><% for (var i=0; i<datasets.length; i++) { %><li><span></span><% if (datasets[i].label) { %><%= datasets[i].label %><% } %></li><% } %></ul>'});var e=na.generateLegend();a("#js-hkba-chart-kbviews-info").append(e)}else a("#js-hkba-chart-kbviews-info").append('<span class="no-results">'+hkbAnalyticsChart.notEnoughResultsString+"</div>")},error:function(a){console.log(a.responseText)},complete:function(a){ea("#js-hkba-dash-views-panel")}})}function f(){a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"feedbackoverview",action:"hkba_dynamic_stats",nonce:R("#js-hkba-feedbacksummary"),begin:ia,end:ja},beforeSend:function(a){da("#js-hkba-dash-articles-panel")},success:function(b){a("#js-hkba-feedbacksummary-helpful").html(b.totalUp),a("#js-hkba-feedbacksummary-unhelpful").html(b.totalDown),a("#js-hkba-feedbacksummary-success").html(b.feedbackArticleSuccess),a(".hkb-dashboardfeedback__summary").removeClass("hkb-dashboardfeedback__summary--neutral"),a(".hkb-dashboardfeedback__summary").removeClass("hkb-dashboardfeedback__summary--good"),a(".hkb-dashboardfeedback__summary").removeClass("hkb-dashboardfeedback__summary--bad"),b.feedbackArticleSuccess>55?a(".hkb-dashboardfeedback__summary").addClass("hkb-dashboardfeedback__summary--good"):b.feedbackArticleSuccess<=55&&b.feedbackArticleSuccess>=45?a(".hkb-dashboardfeedback__summary").addClass("hkb-dashboardfeedback__summary--neutral"):a(".hkb-dashboardfeedback__summary").addClass("hkb-dashboardfeedback__summary--bad"),h("#js-hkba-feedbacksummary-helpful"),h("#js-hkba-feedbacksummary-unhelpful"),h("#js-hkba-feedbacksummary-success")},complete:function(a){ea("#js-hkba-dash-articles-panel")}})}function g(){a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"searchesoverview",action:"hkba_dynamic_stats",nonce:R(" #js-hkba-searchsummary"),begin:ia,end:ja},beforeSend:function(a){da("#js-hkba-dash-search-panel")},success:function(b){a("#js-hkba-searchsummary-total").html(b.totalSuccess),a("#js-hkba-searchsummary-failed").html(b.totalNull),a("#js-hkba-searchsummary-success").html(b.feedbackSuccess),a(".hkb-dashboardsearcheffect__summary").removeClass("hkb-dashboardsearcheffect__summary--neutral"),a(".hkb-dashboardsearcheffect__summary").removeClass("hkb-dashboardsearcheffect__summary--good"),a(".hkb-dashboardsearcheffect__summary").removeClass("hkb-dashboardsearcheffect__summary--bad"),b.feedbackSuccess>55?a(".hkb-dashboardsearcheffect__summary").addClass("hkb-dashboardsearcheffect__summary--good"):b.feedbackSuccess<=55&&b.feedbackSuccess>=45?a(".hkb-dashboardsearcheffect__summary").addClass("hkb-dashboardfeedback__summary--neutral"):a(".hkb-dashboardsearcheffect__summary").addClass("hkb-dashboardsearcheffect__summary--bad"),h("#js-hkba-searchsummary-total"),h("#js-hkba-searchsummary-failed"),h("#js-hkba-searchsummary-success")},complete:function(a){ea("#js-hkba-dash-search-panel")}})}function h(b){a(b).each(function(){var b=a(this),c=b.text();a.isNumeric(c)&&a({Counter:0}).animate({Counter:b.text()},{duration:1e3,easing:"swing",step:function(){b.text(Math.ceil(this.Counter))}})})}function i(){a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"feedbackresponses",action:"hkba_dynamic_stats",nonce:R(".hkb-feedbackbar__block"),begin:ia,end:ja},beforeSend:function(a){da("#js-hkba-feedback-overview-panel")},success:function(b){a(".hkb-feedbackbar_count").html(b.totalResponses),a(".hkb-feedbackbar_good").attr("data-hkb-feedbacknum",b.totalUp),a(".hkb-feedbackbar_good").attr("style","width: "+b.feedbackGoodWidth+"%"),a(".hkb-feedbackbar_bad").attr("data-hkb-feedbacknum",b.totalDown),a(".hkb-feedbackbar_bad").attr("style","width: "+b.feedbackBadWidth+"%")},complete:function(a){ea("#js-hkba-feedback-overview-panel")}})}function j(){!function(a,b,c,d){var e=document.getElementById("ht-analytics-card-template"),f=c.template(e.innerHTML),g=document.getElementById("ht-analytics-card-nofeedback"),h=c.template(g.innerHTML),i=a("#hkba-feedback-pagination").attr("data-page"),j=D(),k=F();a("#js-hkba-feedback-cards-panel").empty().removeClass("hkba-feedbackpanel--nocomments"),ga(),a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"feedbackcards",action:"hkba_dynamic_stats",nonce:R("#js-hkba-feedback-cards-panel"),begin:ia,end:ja,page:i,show:j,comments:k},beforeSend:function(a){da("#js-hkba-feedback-cards-panel")},success:function(b){var c=0;n(),t(),b.cards.length>0?a.each(b.cards,function(b,d){a("#js-hkba-feedback-cards-panel").append(f({feedback:d,index:c})),c++}):(a("#js-hkba-feedback-cards-panel").append(h()),a("#js-hkba-feedback-cards-panel").addClass("hkba-feedbackpanel--nocomments"),"all"==j&&x()),0==b.hasNext&&q(),0==b.hasPrev&&r(),a("#hkba-feedback-pagination").attr("data-page",b.page),a("#hkba-feedback-pagination__prev_a").attr("data-page-target",b.prev),a("#hkba-feedback-pagination__next_a").attr("data-page-target",b.next)},complete:function(a){ea("#js-hkba-feedback-cards-panel"),fa()}})}(jQuery,Backbone,_)}function k(){a("#hkba-feedback-pagination__prev_a").click(function(b){var c=a(this).attr("data-page-target");a("#hkba-feedback-pagination").attr("data-page",c),j()})}function l(){a("#hkba-feedback-pagination__next_a").click(function(b){var c=a(this).attr("data-page-target");a("#hkba-feedback-pagination").attr("data-page",c),j()})}function m(){a("#hkba-feedback-pagination").attr("data-page",1),j()}function n(){o(),p()}function o(){a("#hkba-feedback-pagination__next_a").prop("disabled",!1)}function p(){a("#hkba-feedback-pagination__prev_a").prop("disabled",!1)}function q(){a("#hkba-feedback-pagination__next_a").prop("disabled",!0)}function r(){a("#hkba-feedback-pagination__prev_a").prop("disabled",!0)}function s(){a("button.hkb-feedbackfilter__btn_all").click(function(b){b.preventDefault(),G(),C("all"),a(this).addClass("active"),m()}),a("button.hkb-feedbackfilter__btn_helpful").click(function(b){b.preventDefault(),G(),C("helpful"),a(this).addClass("active"),m()}),a("button.hkb-feedbackfilter__btn_unhelpful").click(function(b){b.preventDefault(),G(),C("unhelpful"),a(this).addClass("active"),m()})}function t(){u(),v(),w()}function u(){a("button.hkb-feedbackfilter__btn_all").prop("disabled",!1)}function v(){a("button.hkb-feedbackfilter__btn_helpful").prop("disabled",!1)}function w(){a("button.hkb-feedbackfilter__btn_unhelpful").prop("disabled",!1)}function x(){y(),z(),A()}function y(){a("button.hkb-feedbackfilter__btn_all").prop("disabled",!0)}function z(){a("button.hkb-feedbackfilter__btn_helpful").prop("disabled",!0)}function A(){a("button.hkb-feedbackfilter__btn_unhelpful").prop("disabled",!0)}function B(){a("button.hkb-feedbackfilter__btn_all_votes").click(function(b){b.preventDefault(),H(),E("all"),a(this).addClass("active"),m()}),a("button.hkb-feedbackfilter__btn_only_comments").click(function(b){b.preventDefault(),H(),E("comments"),a(this).addClass("active"),m()})}function C(b){a("#js-hkba-feedbackfilter-control").attr("data-filter",b)}function D(){var b=a("#js-hkba-feedbackfilter-control").attr("data-filter");return b}function E(b){a("#js-hkba-feedbackfilter-control").attr("data-comments",b)}function F(){var b=a("#js-hkba-feedbackfilter-control").attr("data-comments");return b}function G(){a("button.hkb-feedbackfilter__magnitude_btn").removeClass("active")}function H(){a("button.hkb-feedbackfilter__comments_btn").removeClass("active")}function I(){var b=a("#js-hkba-chart-searchoverview")[0];b.width=b.width,a("#js-hkba-chart-searchoverview-info").empty(),a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"totalsearches",action:"hkba_dynamic_stats",nonce:R("#js-hkba-chart-searchoverview"),begin:ia,end:ja},beforeSend:function(a){da("#js-hkba-search-overview-panel")},success:function(b){if(wa=[{value:b.totalPopulated,color:"#85c468",highlight:"#9ed26a",label:hkbAnalyticsChart.returnedResultsString},{value:b.totalNULL,color:"#e8553e",highlight:"#fa6c51",label:hkbAnalyticsChart.noResultsString}],0!=b.totalSearches){var c=a("#js-hkba-chart-searchoverview"),d=c.get(0).getContext("2d");try{oa.destroy()}catch(a){}oa=new Chart(d).Doughnut(wa,{responsive:!0,maintainAspectRatio:!1,percentageInnerCutout:50,segmentShowStroke:!1,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<segments.length; i++){%><li><span style="background-color:<%=segments[i].fillColor%>"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>'});var e=oa.generateLegend();a("#js-hkba-chart-searchoverview-info").append(e)}else a("#js-hkba-chart-searchoverview-info").append('<span class="no-results">'+hkbAnalyticsChart.notEnoughResultsString+"</div>")},complete:function(a){ea("#js-hkba-search-overview-panel")}})}function J(){var b=a("#js-hkba-chart-kbsearches")[0];b.width=b.width,a("#js-hkba-chart-kbsearches-info").empty(),a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"searchmonthly",action:"hkba_dynamic_stats",nonce:R("#js-hkba-chart-kbsearches"),begin:ia,end:ja},beforeSend:function(a){da("#js-hkba-search-period-panel")},success:function(b){if(xa={labels:b.labels,datasets:[{fillColor:"rgba(74, 136, 218,0.2)",strokeColor:"rgba(74, 136, 218,1.0)",pointColor:"rgba(74, 136, 218,1.0)",pointStrokeColor:"rgba(74, 136, 218,1.0)",pointHighlightFill:"rgba(52, 73, 94,1.0)",pointHighlightStroke:"rgba(52, 73, 94,1.0)",data:b.values}]},0!=b.values.length){var c=a("#js-hkba-chart-kbsearches"),d=c.get(0).getContext("2d");d.canvas.originalwidth=d.canvas.width,d.canvas.originalheight=d.canvas.height;try{ma.destroy()}catch(a){}d.canvas.width=200,d.canvas.height=200,ma=new Chart(d).Line(xa,{responsive:!0,maintainAspectRatio:!1})}else a("#js-hkba-chart-kbsearches-info").append('<span class="no-results">'+hkbAnalyticsChart.notEnoughResultsString+"</div>")},error:function(a){console.log(a.responseText)},complete:function(a){ea("#js-hkba-search-period-panel")}})}function K(){a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"exitsoverview",action:"hkba_dynamic_stats",nonce:R("#js-hkba-transfersummary"),begin:ia,end:ja},beforeSend:function(a){da("#js-hkba-tranfers-metrics-panel")},success:function(b){a("#js-hkba-transfersummary-totalviews").html(b.views),a("#js-hkba-transfersummary-totalviews").attr("title",b.vlabel),a("#js-hkba-transfersummary-totalviews").next(".hkb-transfermetrics__label").attr("title",b.vlabel),a("#js-hkba-transfersummary-totalexits").html(b.exits),a("#js-hkba-transfersummary-totalexits").attr("title",b.elabel),a("#js-hkba-transfersummary-totalexits").next(".hkb-transfermetrics__label").attr("title",b.elabel),a("#js-hkba-transfersummary-success").html(b.percentage),a("#js-hkba-transfersummary-success").attr("title",b.plabel),a(".hkb-transfermetrics__summaryvalue").attr("title",b.plabel)},complete:function(a){ea("#js-hkba-tranfers-metrics-panel")}})}function L(){var b=a("#js-hkba-chart-transferoverview")[0];b.width=b.width,a("#js-hkba-chart-transferoverview-info").empty(),a.ajax({url:ajaxurl,dataType:"JSON",data:{aq:"exitssplit",action:"hkba_dynamic_stats",nonce:R("#js-hkba-chart-transferoverview"),begin:ia,end:ja},beforeSend:function(a){da("#js-hkba-tranfers-split-panel")},success:function(b){if(0!=b.length){var c=a("#js-hkba-chart-transferoverview"),d=c.get(0).getContext("2d");try{pa.destroy()}catch(a){}pa=new Chart(d).Doughnut({},{showTooltips:!0,tooltipTemplate:"<%=label%>"}),b.forEach(function(a){pa.addData({value:a.exitPercentage,color:a.color,highlight:"#C69CBE",label:a.label})},this);var e=pa.generateLegend();a("#js-hkba-chart-transferoverview-info").append(e),pa.update()}else a("#js-hkba-chart-transferoverview-info").append('<span class="no-results">'+hkbAnalyticsChart.notEnoughResultsString+"</div>")},complete:function(a){ea("#js-hkba-tranfers-split-panel")}})}function M(){ra.ajax.reload()}function N(){sa.ajax.reload()}function O(){ta.ajax.reload()}function P(){ua.ajax.reload()}function Q(){"dashboard"==ya?(e(),f(),g()):"articles"==ya||("feedback"==ya?(i(),j()):"search"==ya?(I(),J(),M(),N()):"authors"==ya||"exits"==ya&&(K(),L(),O(),P())),Aa=!0}function R(b){return a(b).data("nonce")}function S(){a("#hkb-period__all-time-btn").click(function(a){a.preventDefault(),T("all-time")}),a("#hkb-period__last-12-months-btn").click(function(a){a.preventDefault(),T("last-12-months")}),a("#hkb-period__last-90-days-btn").click(function(a){a.preventDefault(),T("last-90-days")}),a("#hkb-period__last-30-days-btn").click(function(a){a.preventDefault(),T("last-30-days")}),a("#hkb-period__last-7-days-btn").click(function(a){a.preventDefault(),T("last-7-days")}),a("#hkb-period__custom-period-btn").click(function(a){a.preventDefault(),T("custom-period")})}function T(a){switch(ca(),ka=a,a){case"all-time":U();break;case"last-12-months":V();break;case"last-90-days":W();break;case"last-30-days":X();break;case"last-7-days":Y();break;case"custom-period":Z()}}function U(){var e=new Date;a("#filterDate2").datepicker("setDate",e),e.setYear(e.getFullYear()-5),a("#filterDate1").datepicker("setDate",e),b(),c(),Q(),d(),a("#hkb-period__all-time-btn").parent("li").addClass("active")}function V(){var e=new Date;a("#filterDate2").datepicker("setDate",e),e.setMonth(e.getMonth()-12),a("#filterDate1").datepicker("setDate",e),b(),c(),Q(),d(),a("#hkb-period__last-12-months-btn").parent("li").addClass("active")}function W(){var e=new Date;a("#filterDate2").datepicker("setDate",e),e.setDate(e.getDate()-90),a("#filterDate1").datepicker("setDate",e),b(),c(),Q(),d(),a("#hkb-period__last-90-days-btn").parent("li").addClass("active")}function X(){var e=new Date;a("#filterDate2").datepicker("setDate",e),e.setDate(e.getDate()-30),a("#filterDate1").datepicker("setDate",e),b(),c(),Q(),d(),a("#hkb-period__last-30-days-btn").parent("li").addClass("active")}function Y(){var e=new Date;a("#filterDate2").datepicker("setDate",e),e.setDate(e.getDate()-7),a("#filterDate1").datepicker("setDate",e),b(),c(),Q(),d(),a("#hkb-period__last-7-days-btn").parent("li").addClass("active")}function Z(){Aa||(b(),c(),Q(),d()),a("#hkb-period__custom-period-btn").parent("li").addClass("active"),aa()}function $(){if(""!=za){ca();var b="#hkb-period__"+za+"-btn";a(b).parent("li").addClass("active"),T(za)}else X()}function aa(){la=!0,a("#hkb-period__custom-period-ul").attr("data-ht-visibility","true")}function ba(){a("#hkb-period__custom-period-ul").attr("data-ht-visibility","false")}function ca(){a(".hkba-period li").removeClass("active")}function da(b){a(b).addClass("loading")}function ea(b){a(b).removeClass("loading")}function fa(){var b=a("#js-hkba-feedback-cards-panel").masonry({itemSelector:".hkb-feedbackcard",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0,transitionDuration:0});b.masonry("reloadItems"),b.masonry("layout")}function ga(){a("#js-hkba-feedback-cards-panel").append('<div class="grid-sizer"></div><div class="gutter-sizer"></div>')}function ha(b){var c,d=0,e=0,f=new Array;a(b).each(function(){c=a(this),a(c).height("auto");var b=c.position().top;if(e!=b){for(var g=0;g<f.length;g++)f[g].height(d);f.length=0,e=b,d=c.height(),f.push(c)}else f.push(c),d=d<c.height()?c.height():d;for(g=0;g<f.length;g++)f[g].height(d)})}var ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va={},wa={},xa={},ya=hkbAnalyticsChart.tab,za=hkbAnalyticsChart.userActivePeriod,Aa=!1;a("#filterDate1").datepicker({dateFormat:hkbAnalyticsChart.dateFormat,onSelect:function(a){b(),Q(),d(),ba()}});if(hkbAnalyticsChart.userBeginDate){var Ba=new Date(1e3*parseInt(hkbAnalyticsChart.userBeginDate));a("#filterDate1").datepicker("setDate",Ba)}else{var Ca=new Date;Ca.setMonth(Ca.getMonth()-1),a("#filterDate1").datepicker("setDate",Ca)}b();a("#filterDate2").datepicker({dateFormat:hkbAnalyticsChart.dateFormat,onSelect:function(a){c(),Q(),d(),ba()}});if(hkbAnalyticsChart.userEndDate){var Da=new Date(1e3*parseInt(hkbAnalyticsChart.userEndDate));a("#filterDate2").datepicker("setDate",Da)}else{var Ea=new Date;a("#filterDate2").datepicker("setDate",Ea)}c(),k(),l(),s(),B(),S(),a(document).on("click",function(b){if(la){var c=b.target,d=c.id,e="filterDate1"==d||"filterDate2"==d||"hkb-period__custom-period-ul"==d||"hkb-period__custom-period-btn"==d,f=a(c),g=a("#hkb-period__custom-period-ul").find(f).length>0,h=a("#filterDate1").datepicker("widget").is(":visible"),i=a("#filterDate2").datepicker("widget").is(":visible");e||g||h||i||(ba(),la=!1)}else ba(),la=!1}),a(document).ready(function(){qa=a("table.recent-feedback-result").DataTable({ajax:{url:ajaxurl,data:function(a){a.aq="recentfeedback",a.action="hkba_dynamic_stats",a.begin=ia,a.end=ja,a.nonce=R(".recent-feedback-result")}},order:[[1,"desc"]],responsive:!0}),ra=a("table.null-searches-result").DataTable({ajax:{url:ajaxurl,data:function(a){a.aq="nullsearches",a.action="hkba_dynamic_stats",a.begin=ia,a.end=ja,a.nonce=R(".null-searches-result")},beforeSend:function(a){da("#js-hkba-search-null-panel")},complete:function(a){ea("#js-hkba-search-null-panel")}},order:[[1,"desc"]],searching:!1,lengthChange:!1,pageLength:10,columnDefs:[{targets:0,orderable:!1}],responsive:!0}),sa=a("table.top-searches-result").DataTable({ajax:{url:ajaxurl,data:function(a){a.aq="topsearches",a.action="hkba_dynamic_stats",a.begin=ia,a.end=ja,a.nonce=R(".top-searches-result")},beforeSend:function(a){da("#js-hkba-search-popular-panel")},complete:function(a){ea("#js-hkba-search-popular-panel")}},order:[[1,"desc"]],searching:!1,lengthChange:!1,pageLength:10,columnDefs:[{targets:0,orderable:!1}],responsive:!0}),ta=a("table.category-exits-result").DataTable({ajax:{url:ajaxurl,data:function(a){a.aq="exitsfromcats",a.action="hkba_dynamic_stats",a.begin=ia,a.end=ja,a.nonce=R(".category-exits-result")}},order:[[1,"desc"]],searching:!1,lengthChange:!1,pageLength:10,columnDefs:[{targets:0,orderable:!1}],responsive:!0}),ua=a("table.article-exits-result").DataTable({ajax:{url:ajaxurl,data:function(a){a.aq="exitsfromarticles",a.action="hkba_dynamic_stats",a.begin=ia,a.end=ja,a.nonce=R(".article-exits-result")}},order:[[1,"desc"]],searching:!1,lengthChange:!1,pageLength:10,columnDefs:[{targets:0,orderable:!1}],responsive:!0}),$()}),a(window).load(function(){ha(".hkb-grid__col .hkba-panel--equalheight")}),a(window).resize(function(){ha(".hkb-grid__col .hkba-panel--equalheight")})});